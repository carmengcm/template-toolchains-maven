---
stages:
- name: CI-BUILD
  inputs:
  - url: https://github.ibm.com/Cesar-Rodriguez-Medina/gs-rest-service.git
    type: git
    branch: develop
    dir_name: null
  triggers:
  - type: commit
  jobs:
  - name: Build
    type: builder
    deploy_permission: DEV_IN_SPACE
    extension_id: ibm.devops.services.pipeline.maven.build.deploy
    SERVICE_INSTANCE: (default)
    SONAR_SERVICE_INSTANCE: (default)
    BUILD_COMMAND: "#!/bin/bash\n# environment variables are available:\n# MAVEN_NAME:\
      \ name of the service instance\n# MAVEN_USER_ID: userid for the maven repository\n\
      # MAVEN_TOKEN: the token or password for the maven repository\n# MAVEN_SNAPSHOT_URL:\
      \ the maven snapshot repository\n# MAVEN_RELEASE_URL: the maven release repository\n\
      # MAVEN_MIRROR_URL: the maven mirror repository\n# SONAR_INSTANCE_NAME: the\
      \ name of the SonarQube instance\n# SONAR_SERVER_URL: the url of the SonarQube\
      \ server\n# SONAR_USER_ID: SonarQube user name\n# SONAR_USER_TOKEN: SonarQube\
      \ password or authentication token\n# The settings.xml is available in $HOME/.m2/settings.xml\n\
      # The name of the snapshots repository is 'snapshots'\n# The name of the release\
      \ repository is 'releases'\n# The name of the mirror repository is 'central'\n\
      \nmvn -q clean surefire:test\n#mvn sonar:sonar\nmvn -B -q clean package -DskipTests\
      \ \n\n#mvn -DaltDeploymentRepository=snapshots::default::${MAVEN_SNAPSHOT_URL}\
      \ deploy\n\n#Extract project version\necho 'Extract project version '\n# Future:\
      \ Review how to do with mvn help:evaluate\n#projectVersion=$(mvn help:evaluate\
      \ -Dexpression=project.version | grep -e '^[^\\[]')\nprojectVersion=$(cat pom.xml\
      \ | grep \"^    <version>.*</version>$\" | awk -F'[><]' '{print $3}')\necho\
      \ \"Extracted project version: ${projectVersion}\"\n#Create a tag from project\
      \ version and build number\n\ntagName=${projectVersion}-${BUILD_NUMBER}\necho\
      \ \"Create a tag from project version and build number: ${tagName}\"\ngit tag\
      \ \"${tagName}\"\n# push tag \ngit push origin develop --tags\n\necho 'Created\
      \ tag: ' ${tagName}"
    SERVICE_INSTANCE_TYPE: nexus
- name: Dev - Deploy
  inputs:
  - type: job
    stage: CI-BUILD
    job: Build
    dir_name: null
  triggers:
  - type: stage
  properties:
  - name: PIPELINE_IMAGE_URL
    value: gs-rest-service
    type: text
  jobs:
  - name: Test - WhiteBox
    type: tester
    fail_stage: false
    deploy_permission: DEV_IN_SPACE
    extension_id: ibm.devops.services.pipeline.appscan.static.builder
    target:
      region_id: ibm:yp:us-south
      organization: cesar.rodriguez.medina@ibm.com
      space: AICSpain
    WAIT_TIME: '5'
    SETUP_SERVICE_SPACE: 'true'
  - name: Build - Image2Registry
    type: builder
    artifact_dir: ''
    build_type: cr
    script: "#!/bin/bash\necho -e \"Build environment variables:\"\necho \"REGISTRY_URL=${REGISTRY_URL}\"\
      \necho \"REGISTRY_NAMESPACE=${REGISTRY_NAMESPACE}\"\necho \"IMAGE_NAME=${IMAGE_NAME}\"\
      \necho \"BUILD_NUMBER=${BUILD_NUMBER}\"\n\n# Learn more about the available\
      \ environment variables at:\n# https://console.bluemix.net/docs/services/ContinuousDelivery/pipeline_deploy_var.html#deliverypipeline_environment\n\
      \n# To review or change build options use:\n# bx cr build --help\n\nls -la target/*.jar\n\
      jarToDeploy=$(ls target/*.jar)\necho -e \"Checking for Dockerfile at the repository\
      \ root\"\n#if [ -f Dockerfile ]; then \n#   echo \"Dockerfile found\"\n#else\n\
      echo \"Dockerfile not found. Creating it......\"\nDOCKERFILE_FILE=\"Dockerfile\"\
      \nDockerfile=$(cat <<EOF''\nFROM openjdk:8-jdk-alpine\nADD $jarToDeploy app.jar\n\
      EXPOSE 8080\nENTRYPOINT [\"java\",\"-Djava.security.egd=file:/dev/./urandom\"\
      ,\"-jar\",\"/app.jar\"]\nEOF\n)\n#fi\n\n# Replace the variables\necho \"$Dockerfile\"\
      \ > $DOCKERFILE_FILE\n\nsed -i 's|$jarToDeploy|'\"$jarToDeploy\"'|g' $DOCKERFILE_FILE\n\
      \necho \"cat $DOCKERFILE_FILE\"\ncat $DOCKERFILE_FILE\n\n\necho -e \"Building\
      \ container image\"\nset -x\nbx cr build -t $REGISTRY_URL/$REGISTRY_NAMESPACE/$IMAGE_NAME:$BUILD_NUMBER\
      \ .\nset +x\n"
    namespace: sanalmccc
    image_name: gs-rest-service
    target:
      region_id: ibm:yp:eu-de
      api_key_id: ApiKey-9521f136-f8fe-4002-81f1-c22ca4626ff8
